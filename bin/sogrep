#!/bin/bash

SOYUZ="https://mirror.pkgbuild.com"
SOCACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/sogrep"
repos=('staging' 'testing' 'core' 'extra' 'community-staging' 'community-testing' 'community' 'gnome-unstable' 'kde-unstable')
arches=('i686' 'x86_64')


recache() {
    local repo arch

    for repo in "${repos[@]}"; do
        for arch in "${arches[@]}"; do
            rm -rf "$SOCACHE_DIR/$arch/$repo"
            mkdir -p "$SOCACHE_DIR/$arch/$repo"
            curl $SOYUZ/$repo/os/$arch/$repo.links.tar.gz | bsdtar -xf - -C "$SOCACHE_DIR/$arch/$repo"
        done
    done
}

search() {
    local repo="$1" arch lib="$2"

    for arch in ${arches[@]}; do
        db="$SOCACHE_DIR/$arch/$repo"
        if [[ -d $db ]]; then
            for i in $(grep -rl "${lib}" "${db}"); do
	            pkg=$(basename $(dirname $i))
	            echo ${pkg%-*-*}
            done
        fi
    done | sort -u
}

case $1 in
    recache)
        recache
        ;;
    *)
        search "$@"
        ;;
esac
