#!/bin/bash

# Bugtracker helper utility from Scimmia
# https://gist.github.com/Scimmia22/0fcca58fe0f7c2b5eb906fafc1f32a62

source /usr/share/makepkg/util/message.sh
colorize

usage() {
    cat <<- _EOF_
		Usage: pkg-list-linked-libraries PACKAGE [LIBNAME]

		Check a package to see what libraries it links against.
		Alternatively check against a specific library.

		If PACKAGE is not an existing file, pacman will resolve it
		as a package name and attempt to download it to the cache.
		This respects repo/pkgname syntax.
_EOF_
}

die() {
    error "$@"
    exit 1
}

clean_up() {
    if [[ -d "$workdir" ]]; then
        rm -rf "$workdir"
    fi
}
trap 'clean_up' EXIT

case $1 in
    -h|--help)
        usage
        exit
        ;;
esac

if [[ -f "$1" ]]; then
    pkgfile="$1"
else
    pkgfile_remote="$(pacman -Sp "$1" 2>/dev/null)" || die "package name not in repos"
    pkgfile="/var/cache/pacman/pkg/${pkgfile_remote##*/}"
    if [[ ! -f "$pkgfile" ]]; then
        msg "Downloading package '%s' into pacman's cache" "$1"
        sudo pacman -Swdd --logfile /dev/null "$1" || exit 1
    fi
fi

workdir="$(mktemp -d)"

msg "checking linked libraries for ${pkgfile##*/} ..."
bsdtar xf "$pkgfile" -C "$workdir"
while read file; do
  liblist="$(objdump -p "$file" 2> /dev/null | grep -E "NEEDED\s+$2")"
  [[ -n "$liblist" ]] && printf "%s\n%s\n" "${file#$workdir}" "$liblist" && found=1
done < <(find "$workdir" -type f)

if [[ ! $found && -n $2 ]]; then
    error "No file in %s is linked to %s" "${pkgfile##*/}" "$2"
elif [[ ! $found ]]; then
    error "Uhhh... nothing in %s links to anything whatsoever..." "${pkgfile##*/}"
fi
